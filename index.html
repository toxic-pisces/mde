<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maschinen Pr√ºfsystem</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2a5298">
    
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            position: relative;
        }

        .login-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.5;
        }

        .login-box {
            background: white;
            padding: 50px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
            width: 450px;
            position: relative;
            z-index: 1;
        }

        .login-box h1 {
            color: #1a202c;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .login-box input {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 24px;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .login-box input:focus {
            outline: none;
            border-color: #2a5298;
            background: white;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .login-display {
            width: 100%;
            padding: 24px;
            font-size: 36px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            border: 3px solid #e2e8f0;
            border-radius: 16px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a202c;
            transition: all 0.2s;
        }

        .login-display.empty {
            color: #94a3b8;
            font-size: 16px;
            font-weight: 600;
        }

        .login-numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-numpad-btn {
            height: 60px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 22px;
            font-weight: 600;
            color: #1a202c;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-numpad-btn:hover {
            background: #f8fafc;
            border-color: #2a5298;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.15);
        }

        .login-numpad-btn:active {
            transform: translateY(0);
            background: #2a5298;
            color: white;
        }

        .login-numpad-btn.special {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            font-size: 18px;
        }

        .login-numpad-btn.special:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42, 82, 152, 0.4);
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: 100vh;
            background: #ecf0f1;
        }

        /* Sidebar */
        .sidebar {
            width: 100px;
            background: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 10px;
            box-shadow: 2px 0 24px rgba(0,0,0,0.08);
        }

        .user-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 10px;
            box-shadow: 0 4px 16px rgba(42, 82, 152, 0.4);
        }

        .user-name {
            color: white;
            font-size: 11px;
            text-align: center;
            font-weight: 500;
        }

        .sidebar-btn {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            margin: 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 24px;
            color: rgba(255,255,255,0.85);
        }

        .sidebar-btn:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        .sidebar-btn.database-btn {
            margin-top: auto;
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .sidebar-btn.database-btn:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 40px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            background: #f8fafc;
        }

        .content::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 0;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .content.machine-active::before {
            background: radial-gradient(circle, rgba(16, 185, 129, 0.35) 0%, rgba(16, 185, 129, 0.15) 40%, transparent 70%);
            animation: glowPulse 4s ease-in-out infinite;
            opacity: 1;
        }

        .content.machine-inactive::before {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.35) 0%, rgba(239, 68, 68, 0.15) 40%, transparent 70%);
            animation: glowPulse 4s ease-in-out infinite;
            opacity: 1;
        }

        @keyframes glowPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(0.85);
                opacity: 0.6;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.15);
                opacity: 1;
            }
        }

        /* Main Layout without Card */
        .machine-screen {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr auto auto;
            gap: 40px;
            height: 100%;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .machine-image-section {
            grid-row: 1 / 4;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .machine-image {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
        }

        .machine-image img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            border-radius: 12px;
        }

        .machine-header-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .machine-name {
            font-size: 3rem;
            font-weight: 700;
            color: #1a202c;
            letter-spacing: -1px;
            margin: 0;
        }

        .status-toggle {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 18px 32px;
            border-radius: 16px;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
            cursor: pointer;
            transition: all 0.2s;
            width: fit-content;
        }

        .status-toggle.inactive {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }

        .status-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .status-toggle.inactive:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .part-section {
            background: white;
            padding: 28px 32px;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .part-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .part-info-row:last-child {
            border-bottom: none;
        }

        .part-info-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .part-info-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a202c;
            text-align: right;
        }

        .part-info-value.highlight {
            color: #2a5298;
            font-size: 1.3rem;
        }

        .no-active-inspection {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
            font-size: 0.95rem;
            font-style: italic;
        }

        .action-buttons-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .action-btn {
            padding: 40px 32px;
            font-size: 1.4rem;
            font-weight: 700;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: white;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .btn-complete {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-complete:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.3);
        }

        .btn-st√∂rung {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .btn-st√∂rung:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(245, 158, 11, 0.3);
        }

        /* Barcode Scanner Modal */
        .scanner-modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 24px 60px rgba(0,0,0,0.3);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .scanner-header {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            padding: 28px 35px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scanner-header h2 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin: 0;
        }

        .scanner-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .scanner-close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .scanner-body {
            padding: 35px;
        }

        #reader {
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid #e2e8f0;
            background: #000;
        }

        #reader video {
            width: 100%;
            height: auto;
            display: block;
        }

        .scanner-status {
            margin-top: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }

        .scanner-status.success {
            background: #d1fae5;
            border-color: #10b981;
            color: #047857;
        }

        .scanner-status.error {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .scanner-status-text {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .scanner-result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: 700;
            color: #2a5298;
            letter-spacing: 2px;
        }

        .scanner-fallback {
            margin-top: 25px;
            text-align: center;
        }

        .scanner-fallback-text {
            color: #64748b;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .scanner-fallback input {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            letter-spacing: 1px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .scanner-fallback input:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 24px 60px rgba(0,0,0,0.2);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-header {
            padding: 30px 40px;
            border-bottom: 2px solid #f1f5f9;
        }

        .modal-header h2 {
            color: #1a202c;
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }

        .modal-body {
            padding: 40px;
        }

        /* Responsive Numpad Layout */
        @media (min-width: 900px) and (orientation: landscape) {
            .modal-content {
                max-width: 1000px;
            }

            .numpad-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 40px;
                align-items: start;
            }

            .numpad-left {
                display: flex;
                flex-direction: column;
                gap: 30px;
            }

            .numpad {
                margin-bottom: 0;
            }
        }

        /* Number Input Display */
        .number-input-display {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 3px solid #e2e8f0;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .number-input-display.active {
            border-color: #2a5298;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            box-shadow: 0 0 0 4px rgba(42, 82, 152, 0.1);
        }

        .number-input-label {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }

        .number-input-value {
            font-size: 72px;
            font-weight: 700;
            color: #1a202c;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            letter-spacing: -2px;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-input-value.empty {
            color: #cbd5e1;
        }

        /* Numpad */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .numpad-btn {
            aspect-ratio: 1;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 32px;
            font-weight: 600;
            color: #1a202c;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .numpad-btn:hover {
            background: #f8fafc;
            border-color: #2a5298;
            transform: scale(1.05);
        }

        .numpad-btn:active {
            transform: scale(0.95);
            background: #2a5298;
            color: white;
        }

        .numpad-btn.special {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            font-size: 28px;
        }

        .numpad-btn.special:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .numpad-btn.wide {
            grid-column: span 2;
        }

        /* Input Tabs */
        .input-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .input-tab {
            padding: 20px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .input-tab:hover {
            background: white;
            border-color: #cbd5e1;
        }

        .input-tab.active {
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.3);
        }

        .input-tab-label {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .input-tab-value {
            font-size: 36px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }

        /* Database Modal */
        .database-modal-content {
            max-width: 1200px;
        }

        .database-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px 40px;
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            border-radius: 20px 20px 0 0;
        }

        .database-header h2 {
            color: white;
            margin: 0;
            font-size: 28px;
        }

        .database-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .database-close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .database-body {
            padding: 40px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #64748b;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 15px;
            color: #1a202c;
        }

        .data-table tbody tr:hover {
            background: #f8fafc;
        }

        .data-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .data-badge.io {
            background: #d1fae5;
            color: #065f46;
        }

        .data-badge.nio {
            background: #fee2e2;
            color: #991b1b;
        }

        .data-badge.st√∂rung {
            background: #fef3c7;
            color: #92400e;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 18px;
            color: #64748b;
            font-weight: 600;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-secondary {
            flex: 1;
            padding: 14px 20px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #1a202c;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .btn-secondary:hover {
            border-color: #2a5298;
            background: #f8fafc;
            color: #2a5298;
        }

        /* St√∂rung Options */
        .st√∂rung-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .st√∂rung-option {
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .st√∂rung-option:hover {
            border-color: #f59e0b;
            background: white;
        }

        .st√∂rung-option.selected {
            border-color: #f59e0b;
            background: #fffbeb;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .st√∂rung-option h3 {
            font-size: 16px;
            color: #1a202c;
            font-weight: 600;
            position: relative;
        }
        
        .st√∂rung-option {
            position: relative;
        }

        .timeline-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            margin: 20px 0;
        }

        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f59e0b;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .timeline-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f59e0b;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .timeline-value {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: #f59e0b;
            margin-top: 15px;
        }

        /* Time Skip Button */
        .timeskip-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(59, 130, 246, 0.15);
            backdrop-filter: blur(8px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeskip-btn:hover {
            background: rgba(59, 130, 246, 0.25);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }

        .timeskip-btn:active {
            transform: scale(0.95);
        }

        /* Timeline */
        .timeline-container {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .timeline-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a202c;
        }

        .timeline-current-time {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }

        .timeline-bar {
            position: relative;
            height: 60px;
            background: #f1f5f9;
            border-radius: 8px;
            overflow: visible;
            margin-bottom: 40px;
        }

        .timeline-segment {
            position: absolute;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
            transition: all 0.3s;
            cursor: pointer;
        }

        .timeline-segment:hover {
            filter: brightness(1.1);
            z-index: 10;
        }

        .timeline-segment.pr√ºfung {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .timeline-segment.st√∂rung {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .timeline-legend {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            justify-content: center;
        }

        .timeline-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #64748b;
        }

        .timeline-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .timeline-legend-color.pr√ºfung {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .timeline-legend-color.st√∂rung {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        /* Timeline Time Markers */
        .timeline-markers {
            position: relative;
            height: 20px;
            margin-top: 8px;
            border-top: 1px solid #e2e8f0;
        }

        .timeline-marker {
            position: absolute;
            font-size: 11px;
            color: #94a3b8;
            font-weight: 500;
            transform: translateX(-50%);
            top: 4px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }

        .timeline-marker::before {
            content: '';
            position: absolute;
            width: 1px;
            height: 6px;
            background: #cbd5e1;
            top: -10px;
            left: 50%;
        }

        /* Tooltip */
        .timeline-tooltip {
            position: absolute;
            background: rgba(26, 32, 44, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }

        .timeline-tooltip::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid rgba(26, 32, 44, 0.95);
        }

        /* Timeline Gap Warning */
        .timeline-gap-warning {
            position: absolute;
            top: -30px;
            transform: translateX(-50%);
            font-size: 24px;
            cursor: pointer;
            animation: bounce 1s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            z-index: 100;
        }

        .timeline-gap-warning:hover {
            transform: translateX(-50%) scale(1.2);
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }

        /* Stillstand Overlay - REMOVED */
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>Maschinen Pr√ºfsystem</h1>
            <div class="login-display empty" id="loginDisplay">Pr√ºfnummer eingeben</div>
            <div class="login-numpad">
                <button class="login-numpad-btn" onclick="addLoginDigit('1')">1</button>
                <button class="login-numpad-btn" onclick="addLoginDigit('2')">2</button>
                <button class="login-numpad-btn" onclick="addLoginDigit('3')">3</button>
                <button class="login-numpad-btn" onclick="addLoginDigit('4')">4</button>
                <button class="login-numpad-btn" onclick="addLoginDigit('5')">5</button>
                <button class="login-numpad-btn" onclick="addLoginDigit('6')">6</button>
                <button class="login-numpad-btn" onclick="addLoginDigit('7')">7</button>
                <button class="login-numpad-btn" onclick="addLoginDigit('8')">8</button>
                <button class="login-numpad-btn" onclick="addLoginDigit('9')">9</button>
                <button class="login-numpad-btn special" onclick="clearLoginInput()">‚å´</button>
                <button class="login-numpad-btn" onclick="addLoginDigit('0')">0</button>
                <button class="login-numpad-btn special" onclick="clearAllLogin()">C</button>
            </div>
            <button class="btn-primary" onclick="login()">Anmelden</button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-container hidden">
        <!-- Time Skip Button -->
        <button class="timeskip-btn" onclick="skipTime()">
            <span>‚è≠Ô∏è</span>
            <span>+10 Min</span>
        </button>

        <div class="sidebar">
            <div class="user-profile">
                <div class="user-avatar">üë§</div>
                <div class="user-name" id="userName">Pr√ºfer</div>
            </div>
            <button class="sidebar-btn database-btn" onclick="openDatabase()" title="Datenbank">üóÑÔ∏è</button>
            <button class="sidebar-btn" onclick="openSt√∂rungDatabase()" title="St√∂rungen" style="background: rgba(245, 158, 11, 0.2); border-color: rgba(245, 158, 11, 0.3);">‚ö†Ô∏è</button>
            <button class="sidebar-btn" onclick="logout()" title="Abmelden">üö™</button>
        </div>

        <div class="content">
            <div class="machine-screen">
                <div class="machine-image-section">
                    <div class="machine-image">
                        <img src="./images/machine.png" alt="Maschine" onerror="this.style.display='none'; this.parentElement.innerHTML='‚öôÔ∏è';">
                    </div>
                    <div class="part-section" id="partSection">
                        <div class="no-active-inspection">
                            Keine aktive Pr√ºfung
                        </div>
                    </div>
                </div>

                <div class="machine-header-section">
                    <div class="machine-name">Maschine 01</div>
                    <div style="margin-top: 10px; padding: 15px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; color: white; text-align: center; font-weight: 600;">
                        üî• Firebase PLC Steuerung aktiv
                        <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">√Ñndern Sie "plc/status" in Firebase zum Steuern</div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="timeline-container" style="grid-column: 1 / -1;">
                    <div class="timeline-header">
                            <div class="timeline-title">üìä Zeitstrahl</div>
                            <div class="timeline-current-time" id="currentTime">--:--</div>
                        </div>
                        <div class="timeline-bar" id="timelineBar">
                            <!-- Timeline segments will be rendered here -->
                        </div>
                        <div class="timeline-markers" id="timelineMarkers">
                            <!-- Time markers will be rendered here -->
                        </div>
                        <div class="timeline-legend">
                            <div class="timeline-legend-item">
                                <div class="timeline-legend-color pr√ºfung"></div>
                                <span>Pr√ºfung</span>
                            </div>
                            <div class="timeline-legend-item">
                                <div class="timeline-legend-color st√∂rung"></div>
                                <span>St√∂rung</span>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>

    <script>
        // Use window.mdeState if available (defined in mde-main.js), otherwise create local state
        let state = window.mdeState || {
            pr√ºfnummer: '',
            currentPart: 'Housing',
            machineActive: true,
            pr√ºfungen: [],
            st√∂rungen: [],
            pr√ºfungAktiv: false,
            currentTeilekarte: null,
            pr√ºfungStartzeit: null,
            simulatedTime: new Date(), // Simulierte Zeit f√ºr Time-Skip
            liveUpdateInterval: null,
            lastPr√ºfungEndzeit: null, // Track when last pr√ºfung ended
            unaddressedGapStart: null // Track if there's an unaddressed gap
        };

        // If mdeState exists, ensure it has all required timeline properties
        if (window.mdeState) {
            if (!window.mdeState.simulatedTime) window.mdeState.simulatedTime = new Date();
            if (!window.mdeState.liveUpdateInterval) window.mdeState.liveUpdateInterval = null;
            if (!window.mdeState.lastPr√ºfungEndzeit) window.mdeState.lastPr√ºfungEndzeit = null;
            if (!window.mdeState.unaddressedGapStart) window.mdeState.unaddressedGapStart = null;
            state = window.mdeState;  // Make sure state points to mdeState
        }

        const availableParts = [
            'Housing',
            'Bremskolben',
            'Ventil'
        ];

        let loginValue = '';

        function addLoginDigit(digit) {
            if (loginValue.length < 10) {
                loginValue += digit;
                updateLoginDisplay();
            }
        }

        function clearLoginInput() {
            loginValue = loginValue.slice(0, -1);
            updateLoginDisplay();
        }

        function clearAllLogin() {
            loginValue = '';
            updateLoginDisplay();
        }

        function updateLoginDisplay() {
            const display = document.getElementById('loginDisplay');
            if (loginValue === '') {
                display.textContent = 'Pr√ºfnummer eingeben';
                display.classList.add('empty');
            } else {
                display.textContent = loginValue;
                display.classList.remove('empty');
            }
        }

        function login() {
            if (loginValue.trim()) {
                state.pr√ºfnummer = loginValue.trim();
                document.getElementById('userName').textContent = 'P-' + state.pr√ºfnummer;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                updateContentGlow();
                updateTimeline();
                loginValue = '';
                updateLoginDisplay();
            }
        }

        function updateContentGlow() {
            const content = document.querySelector('.content');
            content.classList.remove('machine-active', 'machine-inactive');
            if (state.machineActive) {
                content.classList.add('machine-active');
            } else {
                content.classList.add('machine-inactive');
            }
        }

        function updateIdleWarning() {
            const content = document.querySelector('.content');
            
            // Check if there's an unaddressed gap that was ignored
            if (state.unaddressedGapStart) {
                const now = state.simulatedTime.getTime();
                const gapDuration = (now - state.unaddressedGapStart) / 60000;
                
                // Strong red for ignored gaps, increasing with time
                if (gapDuration < 15) {
                    const intensity = Math.min(gapDuration / 15, 1);
                    const alpha = 0.25 + (intensity * 0.15); // 0.25 to 0.4
                    content.style.background = `rgba(239, 68, 68, ${alpha})`;
                } else {
                    // Maximum red after 15 minutes
                    content.style.background = `rgba(239, 68, 68, 0.45)`;
                }
                return;
            }
            
            // If pr√ºfung is active and no unaddressed gap, remove warning
            if (state.pr√ºfungAktiv) {
                content.style.removeProperty('background');
                return;
            }
            
            // Calculate idle time
            const now = state.simulatedTime.getTime();
            const lastActivity = state.lastPr√ºfungEndzeit ? state.lastPr√ºfungEndzeit.getTime() : null;
            
            if (!lastActivity) {
                content.style.removeProperty('background');
                return;
            }
            
            const idleMinutes = (now - lastActivity) / 60000;
            
            if (idleMinutes < 5) {
                // Normal - no warning
                content.style.removeProperty('background');
            } else if (idleMinutes < 15) {
                // 5-15 min: light red, increasing intensity
                const intensity = Math.min((idleMinutes - 5) / 10, 1); // 0 to 1 over 10 minutes
                const alpha = 0.08 + (intensity * 0.17); // 0.08 to 0.25
                content.style.background = `rgba(239, 68, 68, ${alpha})`;
            } else {
                // > 15 min: strong red
                content.style.background = `rgba(239, 68, 68, 0.3)`;
            }
        }

        function logout() {
            if (confirm('M√∂chten Sie sich wirklich abmelden?')) {
                state.pr√ºfnummer = '';
                state.pr√ºfungAktiv = false;
                state.currentTeilekarte = null;
                loginValue = '';
                updateLoginDisplay();
                updateMainButton();
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        }

        function updateMainButton() {
            const btn = document.getElementById('mainActionBtn');
            const icon = btn.querySelector('span:first-child');
            const text = document.getElementById('mainActionText');
            const partBtn = document.querySelector('.change-part-btn');
            
            if (state.pr√ºfungAktiv) {
                icon.textContent = '‚úì';
                text.textContent = 'Pr√ºfung abschlie√üen';
                btn.className = 'action-btn btn-complete';
                btn.style.gridColumn = '1 / -1';
                if (partBtn) partBtn.disabled = true;
            } else {
                icon.textContent = '‚ñ∂';
                text.textContent = 'Pr√ºfung starten';
                btn.className = 'action-btn btn-complete';
                btn.style.gridColumn = '1 / -1';
                if (partBtn) partBtn.disabled = false;
            }
        }

        function handleMainAction() {
            if (state.pr√ºfungAktiv) {
                // Pr√ºfung abschlie√üen
                openPr√ºfungModal();
            } else {
                // Pr√ºfung starten - Barcode scannen
                openBarcodeScanner();
            }
        }

        // Barcode Scanner
        let html5QrcodeScanner = null;
        let scanInProgress = false;

        function openBarcodeScanner() {
            scanInProgress = false;
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'barcodeModal';
            modal.onclick = (e) => {
                if (e.target === modal) closeBarcodeScanner();
            };

            modal.innerHTML = `
                <div class="scanner-modal">
                    <div class="scanner-header">
                        <h2>üì∑ Barcode Scanner</h2>
                        <button class="scanner-close-btn" onclick="closeBarcodeScanner()">√ó</button>
                    </div>
                    <div class="scanner-body">
                        <div id="reader"></div>
                        <div class="scanner-status" id="scannerStatus">
                            <p class="scanner-status-text">Richte die Kamera auf einen Barcode...</p>
                        </div>
                        <div class="scanner-fallback">
                            <p class="scanner-fallback-text">oder gib den Code manuell ein:</p>
                            <input
                                type="text"
                                id="manualBarcodeInput"
                                placeholder="Barcode eingeben"
                                onkeypress="if(event.key === 'Enter') submitManualBarcode()"
                            />
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            startBarcodeScanner();
        }

        function startBarcodeScanner() {
            const config = {
                fps: 20,
                qrbox: { width: 400, height: 150 },
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E
                ],
                rememberLastUsedCamera: true,
                aspectRatio: 1.777778
            };

            html5QrcodeScanner = new Html5Qrcode("reader");

            html5QrcodeScanner.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            ).catch(err => {
                console.error("Camera start error:", err);
                const status = document.getElementById('scannerStatus');
                if (status) {
                    status.className = 'scanner-status error';
                    status.innerHTML = `
                        <p class="scanner-status-text">‚ö†Ô∏è Kamera-Zugriff verweigert oder nicht verf√ºgbar</p>
                        <p style="font-size: 13px; margin-top: 10px; font-weight: normal;">Bitte verwende die manuelle Eingabe unten.</p>
                    `;
                }
                setTimeout(() => {
                    const input = document.getElementById('manualBarcodeInput');
                    if (input) input.focus();
                }, 300);
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (scanInProgress) return;
            scanInProgress = true;

            if ('vibrate' in navigator) {
                navigator.vibrate(200);
            }

            const status = document.getElementById('scannerStatus');
            if (status) {
                status.className = 'scanner-status success';
                status.innerHTML = `
                    <p class="scanner-status-text">‚úì Erfolgreich gescannt!</p>
                    <div class="scanner-result">${decodedText}</div>
                `;
            }

            setTimeout(() => {
                processBarcodeResult(decodedText);
            }, 500);
        }

        function onScanError(errorMessage) {
            // Silently ignore scan errors
        }

        function submitManualBarcode() {
            const input = document.getElementById('manualBarcodeInput');
            const barcode = input.value.trim();

            if (barcode.length > 0) {
                if ('vibrate' in navigator) {
                    navigator.vibrate(200);
                }

                const status = document.getElementById('scannerStatus');
                if (status) {
                    status.className = 'scanner-status success';
                    status.innerHTML = `
                        <p class="scanner-status-text">‚úì Manuell eingegeben!</p>
                        <div class="scanner-result">${barcode}</div>
                    `;
                }

                setTimeout(() => {
                    processBarcodeResult(barcode);
                }, 1000);
            }
        }

        function processBarcodeResult(barcode) {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => {
                    console.error("Error stopping scanner:", err);
                    html5QrcodeScanner = null;
                });
            }

            const modal = document.getElementById('barcodeModal');
            if (modal) modal.remove();

            // Generate random data for demo
            const teilekartenNr = barcode;
            const chargeNr = 'CH-' + Math.floor(Math.random() * 900 + 100);
            const laufkartenNr = 'LK-' + Math.floor(Math.random() * 9000 + 1000);
            const teil = availableParts[Math.floor(Math.random() * availableParts.length)];

            showTeilekartenInfo(teilekartenNr, chargeNr, laufkartenNr, teil);
        }

        function closeBarcodeScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => {
                    console.error("Error stopping scanner:", err);
                    html5QrcodeScanner = null;
                });
            }

            const modal = document.getElementById('barcodeModal');
            if (modal) modal.remove();

            scanInProgress = false;
        }

        function showTeilekartenInfo(teilekartenNr, chargeNr, laufkartenNr, teil) {
            closeModal();
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'teilekartenModal';
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚úì Teilekarte erfasst</h2>
                    </div>
                    <div class="modal-body">
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <div style="padding: 24px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 3px solid #2a5298; border-radius: 16px;">
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">Teil</div>
                                        <div style="font-size: 24px; font-weight: 700; color: #1a202c;">üì¶ ${teil}</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div>
                                            <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">Teilekarten-Nr.</div>
                                            <div style="font-size: 18px; font-weight: 700; color: #2a5298;">${teilekartenNr}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">Charge-Nr.</div>
                                            <div style="font-size: 18px; font-weight: 700; color: #2a5298;">${chargeNr}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">Laufkarten-Nr.</div>
                                        <div style="font-size: 18px; font-weight: 700; color: #2a5298;">${laufkartenNr}</div>
                                    </div>
                                </div>
                            </div>
                            <p style="text-align: center; color: #64748b; font-size: 16px;">Bitte w√§hlen Sie den Pr√ºfzyklus:</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                <div class="st√∂rung-option" id="zyklus-1" onclick="selectPr√ºfzyklus(this, 1)" style="padding: 20px; text-align: center;">
                                    <h3 style="font-size: 18px; margin: 0;">Pr√ºfzyklus 1</h3>
                                </div>
                                <div class="st√∂rung-option" id="zyklus-2" onclick="selectPr√ºfzyklus(this, 2)" style="padding: 20px; text-align: center;">
                                    <h3 style="font-size: 18px; margin: 0;">Pr√ºfzyklus 2</h3>
                                </div>
                                <div class="st√∂rung-option" id="zyklus-3" onclick="selectPr√ºfzyklus(this, 3)" style="padding: 20px; text-align: center;">
                                    <h3 style="font-size: 18px; margin: 0;">Pr√ºfzyklus 3</h3>
                                </div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="btn-secondary" onclick="closeModal()">Abbrechen</button>
                            <button class="btn-primary" id="confirmPr√ºfzyklusBtn" onclick="confirmPr√ºfzyklus('${teilekartenNr}', '${chargeNr}', '${laufkartenNr}', '${teil}')" disabled style="opacity: 0.5;">Best√§tigen & Starten</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function startPr√ºfung(teilekartenNr, chargeNr, laufkartenNr, teil, pr√ºfzyklus) {
            state.pr√ºfungAktiv = true;
            state.pr√ºfungStartzeit = new Date(state.simulatedTime);
            state.currentTeilekarte = {
                teilekartenNr: teilekartenNr,
                chargeNr: chargeNr,
                laufkartenNr: laufkartenNr,
                teil: teil,
                pr√ºfzyklus: pr√ºfzyklus
            };
            state.currentPart = teil;
            
            // Start live update for timeline
            if (state.liveUpdateInterval) {
                clearInterval(state.liveUpdateInterval);
            }
            state.liveUpdateInterval = setInterval(() => {
                updateTimeline();
            }, 1000);
            
            // Update UI
            updatePartSection();
            updateMainButton();
            updateTimeline();
            updateIdleWarning();
            
            closeModal();
            showSuccess(`Pr√ºfung gestartet f√ºr ${teil} (Pr√ºfzyklus ${pr√ºfzyklus})`);
        }

        function updatePartSection() {
            const section = document.getElementById('partSection');
            
            if (!state.pr√ºfungAktiv || !state.currentTeilekarte) {
                section.innerHTML = `
                    <div class="no-active-inspection">
                        Keine aktive Pr√ºfung
                    </div>
                `;
                return;
            }

            const tk = state.currentTeilekarte;
            section.innerHTML = `
                <div class="part-info-row">
                    <span class="part-info-label">Teil</span>
                    <span class="part-info-value highlight">${tk.teil}</span>
                </div>
                <div class="part-info-row">
                    <span class="part-info-label">Pr√ºfzyklus</span>
                    <span class="part-info-value highlight">${tk.pr√ºfzyklus}</span>
                </div>
                <div class="part-info-row">
                    <span class="part-info-label">TBK-Nr.</span>
                    <span class="part-info-value">${tk.teilekartenNr}</span>
                </div>
                <div class="part-info-row">
                    <span class="part-info-label">Charge</span>
                    <span class="part-info-value">${tk.chargeNr}</span>
                </div>
                <div class="part-info-row">
                    <span class="part-info-label">Laufkarte</span>
                    <span class="part-info-value">${tk.laufkartenNr}</span>
                </div>
            `;
        }

        let currentInputField = 'io';
        let inputValues = { io: '', nio: '' };
        let hasConfirmedIO = false;
        let selectedFehler = [];
        let showFehlerSelection = false;

        function openPr√ºfungModal() {
            currentInputField = 'io';
            inputValues = { io: '', nio: '' };
            hasConfirmedIO = false;
            selectedFehler = [];
            showFehlerSelection = false;

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'pr√ºfungModal';
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚úì Pr√ºfung abgeschlossen</h2>
                    </div>
                    <div class="modal-body">
                        <div class="numpad-container">
                            <div class="numpad-left">
                                <div class="input-tabs">
                                    <div class="input-tab active" id="tab-io" onclick="switchInputField('io')">
                                        <div class="input-tab-label">i.O. Teile</div>
                                        <div class="input-tab-value" id="display-io">0</div>
                                    </div>
                                    <div class="input-tab" id="tab-nio" onclick="switchInputField('nio')">
                                        <div class="input-tab-label">n.i.O. Teile</div>
                                        <div class="input-tab-value" id="display-nio">0</div>
                                    </div>
                                </div>

                                <div class="number-input-display active" id="activeDisplay">
                                    <div class="number-input-label" id="activeLabel">i.O. Teileanzahl eingeben</div>
                                    <div class="number-input-value" id="activeValue">0</div>
                                </div>

                                <div class="modal-buttons">
                                    <button class="btn-secondary" onclick="closeModal()">Abbrechen</button>
                                    <button class="btn-primary" id="confirmBtn" onclick="handleConfirm()">Weiter zu n.i.O.</button>
                                </div>
                            </div>

                            <div class="numpad">
                                <button class="numpad-btn" onclick="addDigit('1')">1</button>
                                <button class="numpad-btn" onclick="addDigit('2')">2</button>
                                <button class="numpad-btn" onclick="addDigit('3')">3</button>
                                <button class="numpad-btn" onclick="addDigit('4')">4</button>
                                <button class="numpad-btn" onclick="addDigit('5')">5</button>
                                <button class="numpad-btn" onclick="addDigit('6')">6</button>
                                <button class="numpad-btn" onclick="addDigit('7')">7</button>
                                <button class="numpad-btn" onclick="addDigit('8')">8</button>
                                <button class="numpad-btn" onclick="addDigit('9')">9</button>
                                <button class="numpad-btn special" onclick="clearInput()">‚å´</button>
                                <button class="numpad-btn" onclick="addDigit('0')">0</button>
                                <button class="numpad-btn special" onclick="clearAll()">C</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            updateDisplay();
        }

        function switchInputField(field) {
            currentInputField = field;
            document.getElementById('tab-io').classList.toggle('active', field === 'io');
            document.getElementById('tab-nio').classList.toggle('active', field === 'nio');
            
            const label = field === 'io' ? 'i.O. Teileanzahl eingeben' : 'n.i.O. Teileanzahl eingeben';
            document.getElementById('activeLabel').textContent = label;
            
            // Update button text based on current field
            const confirmBtn = document.getElementById('confirmBtn');
            if (field === 'io' && !hasConfirmedIO) {
                confirmBtn.textContent = 'Weiter zu n.i.O.';
            } else {
                confirmBtn.textContent = 'Best√§tigen';
            }
            
            updateDisplay();
        }

        function handleConfirm() {
            // If we're on i.O. field and haven't confirmed yet, switch to n.i.O.
            if (currentInputField === 'io' && !hasConfirmedIO) {
                hasConfirmedIO = true;
                switchInputField('nio');
            } else {
                // Check if we need to show Fehlermerkmale selection
                const nioCount = parseInt(inputValues.nio) || 0;
                if (nioCount > 0 && !showFehlerSelection) {
                    showFehlerSelection = true;
                    renderFehlermerkmaleSelection();
                } else {
                    // Otherwise, save the Pr√ºfung
                    savePr√ºfung();
                }
            }
        }

        function renderFehlermerkmaleSelection() {
            const modal = document.getElementById('pr√ºfungModal');
            if (!modal) return;

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ö†Ô∏è Fehlermerkmale ausw√§hlen</h2>
                    </div>
                    <div class="modal-body">
                        <p style="text-align: center; color: #64748b; margin-bottom: 30px; font-size: 16px;">
                            W√§hlen Sie die Fehlermerkmale in der Reihenfolge ihrer H√§ufigkeit aus:
                        </p>
                        
                        <div class="st√∂rung-options" style="margin-bottom: 30px;">
                            <div class="st√∂rung-option" id="fehler-rundheit" onclick="selectFehler(this, 'Rundheit')">
                                <h3>üîµ Rundheit</h3>
                                <span class="fehler-nummer" style="display: none;"></span>
                            </div>
                            <div class="st√∂rung-option" id="fehler-durchmesser" onclick="selectFehler(this, 'Durchmesser')">
                                <h3>‚≠ï Durchmesser</h3>
                                <span class="fehler-nummer" style="display: none;"></span>
                            </div>
                            <div class="st√∂rung-option" id="fehler-laenge" onclick="selectFehler(this, 'L√§nge')">
                                <h3>üìè L√§nge</h3>
                                <span class="fehler-nummer" style="display: none;"></span>
                            </div>
                            <div class="st√∂rung-option" id="fehler-winkel" onclick="selectFehler(this, 'Winkel')">
                                <h3>üìê Winkel</h3>
                                <span class="fehler-nummer" style="display: none;"></span>
                            </div>
                        </div>

                        <div class="modal-buttons">
                            <button class="btn-secondary" onclick="closeModal()">Abbrechen</button>
                            <button class="btn-primary" onclick="savePr√ºfung()">Best√§tigen</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function selectFehler(element, fehlerTyp) {
            const fehlerNummerSpan = element.querySelector('.fehler-nummer');
            
            // Check if already selected
            const existingIndex = selectedFehler.findIndex(f => f.type === fehlerTyp);
            
            if (existingIndex !== -1) {
                // Deselect
                selectedFehler.splice(existingIndex, 1);
                element.classList.remove('selected');
                fehlerNummerSpan.style.display = 'none';
                
                // Renumber remaining
                updateFehlerNumbers();
            } else {
                // Select
                const nummer = selectedFehler.length + 1;
                selectedFehler.push({ type: fehlerTyp, nummer: nummer });
                element.classList.add('selected');
                fehlerNummerSpan.textContent = nummer;
                fehlerNummerSpan.style.display = 'inline-block';
                fehlerNummerSpan.style.cssText = `
                    display: inline-block;
                    background: #2a5298;
                    color: white;
                    width: 28px;
                    height: 28px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 700;
                    font-size: 14px;
                    margin-left: 10px;
                    position: absolute;
                    right: 16px;
                    top: 50%;
                    transform: translateY(-50%);
                `;
            }
        }

        function updateFehlerNumbers() {
            // Update all selected fehler with new numbers
            selectedFehler.forEach((fehler, index) => {
                fehler.nummer = index + 1;
                const element = document.getElementById(`fehler-${fehler.type.toLowerCase()}`);
                if (element) {
                    const nummerSpan = element.querySelector('.fehler-nummer');
                    if (nummerSpan) {
                        nummerSpan.textContent = fehler.nummer;
                    }
                }
            });
        }

        function addDigit(digit) {
            if (inputValues[currentInputField].length < 4) {
                inputValues[currentInputField] += digit;
                updateDisplay();
            }
        }

        function clearInput() {
            inputValues[currentInputField] = inputValues[currentInputField].slice(0, -1);
            updateDisplay();
        }

        function clearAll() {
            inputValues[currentInputField] = '';
            updateDisplay();
        }

        function updateDisplay() {
            const value = inputValues[currentInputField] || '0';
            document.getElementById('activeValue').textContent = value;
            document.getElementById('display-io').textContent = inputValues.io || '0';
            document.getElementById('display-nio').textContent = inputValues.nio || '0';
        }

        function savePr√ºfung() {
            const ioCount = parseInt(inputValues.io) || 0;
            const nioCount = parseInt(inputValues.nio) || 0;
            
            const now = new Date(state.simulatedTime);
            const startzeit = state.pr√ºfungStartzeit ? state.pr√ºfungStartzeit.toLocaleString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }) : '-';
            
            const endzeit = now.toLocaleString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            // For Pr√ºfzyklus 2 and 3, set TBK-Nr to null
            const tbkNr = state.currentTeilekarte.pr√ºfzyklus === 1 
                ? state.currentTeilekarte.teilekartenNr 
                : null;

            const pr√ºfung = {
                id: Date.now(),
                startzeit: state.pr√ºfungStartzeit,
                endzeit: now,
                startzeitFormatted: startzeit,
                endzeitFormatted: endzeit,
                pr√ºfnummer: state.pr√ºfnummer,
                part: state.currentPart,
                pr√ºfzyklus: state.currentTeilekarte.pr√ºfzyklus,
                teilekarte: {
                    ...state.currentTeilekarte,
                    teilekartenNr: tbkNr
                },
                io: ioCount,
                nio: nioCount,
                total: ioCount + nioCount,
                fehlermerkmale: selectedFehler.length > 0 ? selectedFehler : null,
                type: 'pr√ºfung'
            };
            state.pr√ºfungen.push(pr√ºfung);
            console.log('Pr√ºfung gespeichert:', pr√ºfung);
            
            // Update last pr√ºfung end time
            state.lastPr√ºfungEndzeit = now;
            
            // Stop live update
            if (state.liveUpdateInterval) {
                clearInterval(state.liveUpdateInterval);
                state.liveUpdateInterval = null;
            }
            
            // Reset Pr√ºfung
            state.pr√ºfungAktiv = false;
            state.currentTeilekarte = null;
            state.pr√ºfungStartzeit = null;
            updateMainButton();
            updatePartSection();
            updateTimeline();
            updateIdleWarning();
            
            closeModal();
            showSuccess(`Pr√ºfung gespeichert: ${ioCount} i.O. / ${nioCount} n.i.O.`);
        }

        function openSt√∂rungModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'st√∂rungModal';
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ö†Ô∏è St√∂rung melden</h2>
                    </div>
                    <div class="modal-body">
                        <div class="st√∂rung-options">
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Kalibrierung fehlgeschlagen')">
                                <h3>üîß Kalibrierung fehlgeschlagen</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'NIO voll')">
                                <h3>üì¶ NIO voll</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Teile Zuf√ºhrung')">
                                <h3>‚¨áÔ∏è Teile Zuf√ºhrung</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Reperatur')">
                                <h3>üî® Reperatur</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Rabbit Pr√ºfung')">
                                <h3>üê∞ Rabbit Pr√ºfung</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Keine Rohlinge')">
                                <h3>‚ùå Keine Rohlinge</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Teile Abf√ºhrung')">
                                <h3>‚¨ÜÔ∏è Teile Abf√ºhrung</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Dokumentation')">
                                <h3>üìÑ Dokumentation</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Monteur Einsatz')">
                                <h3>üë∑ Monteur Einsatz</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Ablauffehler')">
                                <h3>‚ö†Ô∏è Ablauffehler</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Aushilfe andere Anlage')">
                                <h3>üîÑ Aushilfe andere Anlage</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Sonstiges')">
                                <h3>üìù Sonstiges</h3>
                            </div>
                        </div>
                        
                        <div id="sonstigesInput" class="hidden" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px;">Bitte beschreiben Sie die St√∂rung:</label>
                            <input type="text" 
                                   id="sonstigesText" 
                                   placeholder="St√∂rungsgrund eingeben"
                                   style="width: 100%; padding: 16px 20px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 12px; transition: all 0.2s ease;"
                                   onfocus="this.style.borderColor='#2a5298'; this.style.boxShadow='0 0 0 3px rgba(42, 82, 152, 0.1)';"
                                   onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px;">Dauer in Minuten:</label>
                            <input type="range" class="timeline-slider" id="st√∂rungDuration" min="1" max="120" value="30" oninput="updateDuration()">
                            <div class="timeline-value" id="durationDisplay">30 min</div>
                        </div>
                        
                        <div class="modal-buttons">
                            <button class="btn-secondary" onclick="closeModal()">Abbrechen</button>
                            <button class="btn-primary" onclick="saveSt√∂rung()">Best√§tigen</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        let selectedSt√∂rung = null;
        let selectedPr√ºfzyklus = null;

        function selectPr√ºfzyklus(el, zyklus) {
            document.querySelectorAll('#zyklus-1, #zyklus-2, #zyklus-3').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedPr√ºfzyklus = zyklus;
            
            // Enable confirm button
            const confirmBtn = document.getElementById('confirmPr√ºfzyklusBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';
            }
        }

        function confirmPr√ºfzyklus(teilekartenNr, chargeNr, laufkartenNr, teil) {
            if (!selectedPr√ºfzyklus) {
                alert('Bitte w√§hlen Sie einen Pr√ºfzyklus aus!');
                return;
            }
            startPr√ºfung(teilekartenNr, chargeNr, laufkartenNr, teil, selectedPr√ºfzyklus);
            selectedPr√ºfzyklus = null;
        }

        function selectSt√∂rung(el, type) {
            document.querySelectorAll('.st√∂rung-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedSt√∂rung = type;
            
            // Show/hide text input for "Sonstiges"
            const sonstigesInput = document.getElementById('sonstigesInput');
            if (type === 'Sonstiges') {
                sonstigesInput.classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('sonstigesText').focus();
                }, 100);
            } else {
                sonstigesInput.classList.add('hidden');
            }
        }

        function updateDuration() {
            const val = document.getElementById('st√∂rungDuration').value;
            document.getElementById('durationDisplay').textContent = val + ' min';
        }

        function saveSt√∂rung() {
            if (!selectedSt√∂rung) {
                alert('Bitte w√§hlen Sie eine St√∂rung aus!');
                return;
            }
            
            let st√∂rungText = selectedSt√∂rung;
            
            // If "Sonstiges" is selected, get custom text
            if (selectedSt√∂rung === 'Sonstiges') {
                const customText = document.getElementById('sonstigesText').value.trim();
                if (!customText) {
                    alert('Bitte beschreiben Sie die St√∂rung!');
                    return;
                }
                st√∂rungText = 'Sonstiges: ' + customText;
            }
            
            const duration = parseInt(document.getElementById('st√∂rungDuration').value);
            
            const now = new Date(state.simulatedTime);
            const timestamp = now.toLocaleString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // St√∂rung geht r√ºckw√§rts: endTime = jetzt, startTime = jetzt - duration
            const st√∂rung = {
                id: Date.now(),
                timestamp: timestamp,
                startTime: new Date(now.getTime() - duration * 60000),
                endTime: new Date(now),
                pr√ºfnummer: state.pr√ºfnummer,
                type: st√∂rungText,
                duration: duration,
                st√∂rungType: 'st√∂rung'
            };
            state.st√∂rungen.push(st√∂rung);
            console.log('St√∂rung gespeichert:', st√∂rung);
            
            closeModal();
            selectedSt√∂rung = null;
            updateTimeline();
            showSuccess(`St√∂rung gemeldet: ${st√∂rungText} (${duration} Min)`);
        }

        // Time Skip Function
        function skipTime() {
            // Skip 10 minutes
            state.simulatedTime = new Date(state.simulatedTime.getTime() + 10 * 60000);
            updateTimeline();
            showSuccess(`Zeit vorgesprungen: +10 Minuten (${state.simulatedTime.toLocaleTimeString('de-DE')})`);
            console.log('Simulierte Zeit:', state.simulatedTime);
        }

        // Timeline Functions
        function updateTimeline() {
            // Update current time display
            const currentTimeEl = document.getElementById('currentTime');
            if (currentTimeEl) {
                currentTimeEl.textContent = state.simulatedTime.toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            const timelineBar = document.getElementById('timelineBar');
            const timelineMarkers = document.getElementById('timelineMarkers');
            if (!timelineBar) return;

            // Clear existing segments and markers
            timelineBar.innerHTML = '';
            if (timelineMarkers) timelineMarkers.innerHTML = '';

            // Calculate timeline window (last 2 hours)
            const now = state.simulatedTime.getTime();
            const twoHoursAgo = now - (2 * 60 * 60 * 1000);

            // Add time markers every 15 minutes
            if (timelineMarkers) {
                for (let i = 0; i <= 8; i++) {
                    const timeOffset = i * 15 * 60 * 1000;
                    const markerTime = new Date(twoHoursAgo + timeOffset);
                    const marker = document.createElement('div');
                    marker.className = 'timeline-marker';
                    marker.style.left = `${(i / 8) * 100}%`;
                    marker.textContent = markerTime.toLocaleTimeString('de-DE', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    timelineMarkers.appendChild(marker);
                }
            }

            // Collect all events (pr√ºfungen and st√∂rungen)
            const events = [];

            // Add pr√ºfungen (including active one)
            state.pr√ºfungen.forEach(pr√ºfung => {
                const start = pr√ºfung.startzeit ? new Date(pr√ºfung.startzeit).getTime() : null;
                const end = pr√ºfung.endzeit ? new Date(pr√ºfung.endzeit).getTime() : null;
                if (start && end && end > twoHoursAgo && start < now) {
                    events.push({
                        type: 'pr√ºfung',
                        start: Math.max(start, twoHoursAgo),
                        end: Math.min(end, now),
                        data: pr√ºfung
                    });
                }
            });

            // Add active pr√ºfung (live)
            if (state.pr√ºfungAktiv && state.pr√ºfungStartzeit) {
                const start = new Date(state.pr√ºfungStartzeit).getTime();
                const end = now;
                if (end > twoHoursAgo && start < now) {
                    events.push({
                        type: 'pr√ºfung',
                        start: Math.max(start, twoHoursAgo),
                        end: Math.min(end, now),
                        data: {
                            io: 0,
                            nio: 0,
                            total: 0,
                            isLive: true
                        }
                    });
                }
            }

            // Add st√∂rungen - FIX: jetzt werden sie korrekt hinzugef√ºgt
            state.st√∂rungen.forEach(st√∂rung => {
                const start = st√∂rung.startTime ? new Date(st√∂rung.startTime).getTime() : null;
                const end = st√∂rung.endTime ? new Date(st√∂rung.endTime).getTime() : null;
                
                if (start && end) {
                    if (end > twoHoursAgo && start < now) {
                        events.push({
                            type: 'st√∂rung',
                            start: Math.max(start, twoHoursAgo),
                            end: Math.min(end, now),
                            data: st√∂rung
                        });
                    }
                }
            });

            // Sort events by start time
            events.sort((a, b) => a.start - b.start);

            // Detect gaps > 5 minutes between events
            const gaps = [];
            const pr√ºfungEvents = events.filter(e => e.type === 'pr√ºfung');
            
            // Check gaps between completed pr√ºfungen
            for (let i = 0; i < pr√ºfungEvents.length - 1; i++) {
                const currentEnd = pr√ºfungEvents[i].end;
                const nextStart = pr√ºfungEvents[i + 1].start;
                const gapDuration = nextStart - currentEnd;
                
                // Check if there's already a st√∂rung covering this gap
                const hasSt√∂rung = events.some(e => 
                    e.type === 'st√∂rung' && 
                    e.start <= currentEnd && 
                    e.end >= nextStart
                );
                
                if (gapDuration > 5 * 60 * 1000 && !hasSt√∂rung) {
                    gaps.push({
                        start: currentEnd,
                        end: nextStart,
                        duration: gapDuration
                    });
                }
            }
            
            // Check if there's a current gap (no active pr√ºfung and last one ended > 5 min ago)
            if (!state.pr√ºfungAktiv && state.lastPr√ºfungEndzeit) {
                const lastEnd = state.lastPr√ºfungEndzeit.getTime();
                const currentGapDuration = now - lastEnd;
                
                // Check if there's a st√∂rung covering this current gap
                const hasSt√∂rung = events.some(e => 
                    e.type === 'st√∂rung' && 
                    e.start <= lastEnd && 
                    e.end >= now
                );
                
                if (currentGapDuration > 5 * 60 * 1000 && !hasSt√∂rung) {
                    gaps.push({
                        start: lastEnd,
                        end: now,
                        duration: currentGapDuration,
                        isCurrent: true
                    });
                    
                    // Mark this as an unaddressed gap if not already marked
                    if (!state.unaddressedGapStart) {
                        state.unaddressedGapStart = lastEnd;
                    }
                }
            }
            
            console.log('Gaps detected:', gaps.length, gaps);
            console.log('Unaddressed gap start:', state.unaddressedGapStart);
            
            // Update idle warning
            updateIdleWarning();

            // Render segments
            const timelineWidth = 2 * 60 * 60 * 1000; // 2 hours in ms
            events.forEach(event => {
                const segment = document.createElement('div');
                segment.className = `timeline-segment ${event.type}`;
                
                const startPercent = ((event.start - twoHoursAgo) / timelineWidth) * 100;
                const widthPercent = ((event.end - event.start) / timelineWidth) * 100;
                
                segment.style.left = `${startPercent}%`;
                segment.style.width = `${widthPercent}%`;
                
                // Add better tooltip with hover
                const startTime = new Date(event.start).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const endTime = new Date(event.end).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const duration = Math.round((event.end - event.start) / 60000);
                
                let tooltipText = '';
                if (event.type === 'pr√ºfung') {
                    if (event.data.isLive) {
                        tooltipText = `Pr√ºfung l√§uft...\n${startTime} - ${endTime} (${duration} Min)`;
                        segment.textContent = widthPercent > 8 ? '‚è±Ô∏è' : '';
                        segment.style.opacity = '0.8';
                    } else {
                        tooltipText = `Pr√ºfung\n${startTime} - ${endTime} (${duration} Min)\nGefertigt: ${event.data.total} Teile (${event.data.io} i.O. / ${event.data.nio} n.i.O.)`;
                        segment.textContent = widthPercent > 8 ? `${event.data.total}` : '';
                    }
                } else {
                    tooltipText = `St√∂rung\n${startTime} - ${endTime} (${duration} Min)\n${event.data.type}`;
                    segment.textContent = widthPercent > 8 ? `‚ö†Ô∏è` : '';
                }
                
                segment.title = tooltipText;
                
                // Add custom hover tooltip
                segment.addEventListener('mouseenter', (e) => {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'timeline-tooltip';
                    tooltip.id = 'customTooltip';
                    tooltip.innerHTML = tooltipText.replace(/\n/g, '<br>');
                    document.body.appendChild(tooltip);
                    
                    const rect = segment.getBoundingClientRect();
                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                    tooltip.style.top = `${rect.top - 10}px`;
                    tooltip.style.transform = 'translate(-50%, -100%)';
                });
                
                segment.addEventListener('mouseleave', () => {
                    const tooltip = document.getElementById('customTooltip');
                    if (tooltip) tooltip.remove();
                });
                
                timelineBar.appendChild(segment);
            });

            // Render gap warnings
            gaps.forEach((gap, index) => {
                const gapCenter = (gap.start + gap.end) / 2;
                const centerPercent = ((gapCenter - twoHoursAgo) / timelineWidth) * 100;
                
                console.log(`Gap ${index}: centerPercent=${centerPercent}%`);
                
                if (centerPercent >= 0 && centerPercent <= 100) {
                    const warning = document.createElement('div');
                    warning.className = 'timeline-gap-warning';
                    warning.style.left = `${centerPercent}%`;
                    warning.style.position = 'absolute';
                    warning.textContent = '‚ö†Ô∏è';
                    warning.title = 'Klicken um St√∂rung zu melden';
                    warning.onclick = (e) => {
                        e.stopPropagation();
                        openSt√∂rungModalForGap(gap);
                    };
                    timelineBar.appendChild(warning);
                    console.log('Warning added to timeline:', warning);
                }
            });
        }

        function openSt√∂rungModalForGap(gap) {
            // Calculate duration in minutes
            const durationMinutes = Math.round((gap.end - gap.start) / 60000);
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'st√∂rungModal';
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ö†Ô∏è St√∂rung melden</h2>
                    </div>
                    <div class="modal-body">
                        <p style="text-align: center; margin-bottom: 20px; color: #64748b;">
                            Automatische Erkennung: Pause von <strong>${durationMinutes} Minuten</strong> erkannt
                        </p>
                        <div class="st√∂rung-options">
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Kalibrierung fehlgeschlagen')">
                                <h3>üîß Kalibrierung fehlgeschlagen</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'NIO voll')">
                                <h3>üì¶ NIO voll</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Teile Zuf√ºhrung')">
                                <h3>‚¨áÔ∏è Teile Zuf√ºhrung</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Reperatur')">
                                <h3>üî® Reperatur</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Rabbit Pr√ºfung')">
                                <h3>üê∞ Rabbit Pr√ºfung</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Keine Rohlinge')">
                                <h3>‚ùå Keine Rohlinge</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Teile Abf√ºhrung')">
                                <h3>‚¨ÜÔ∏è Teile Abf√ºhrung</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Dokumentation')">
                                <h3>üìÑ Dokumentation</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Monteur Einsatz')">
                                <h3>üë∑ Monteur Einsatz</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Ablauffehler')">
                                <h3>‚ö†Ô∏è Ablauffehler</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Aushilfe andere Anlage')">
                                <h3>üîÑ Aushilfe andere Anlage</h3>
                            </div>
                            <div class="st√∂rung-option" onclick="selectSt√∂rung(this, 'Sonstiges')">
                                <h3>üìù Sonstiges</h3>
                            </div>
                        </div>
                        
                        <div id="sonstigesInput" class="hidden" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px;">Bitte beschreiben Sie die St√∂rung:</label>
                            <input type="text" 
                                   id="sonstigesText" 
                                   placeholder="St√∂rungsgrund eingeben"
                                   style="width: 100%; padding: 16px 20px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 12px; transition: all 0.2s ease;"
                                   onfocus="this.style.borderColor='#2a5298'; this.style.boxShadow='0 0 0 3px rgba(42, 82, 152, 0.1)';"
                                   onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                        </div>
                        
                        <div class="modal-buttons">
                            <button class="btn-secondary" onclick="closeModal()">Abbrechen</button>
                            <button class="btn-primary" onclick="saveSt√∂rungForGap(${gap.start}, ${gap.end})">Best√§tigen</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSt√∂rungForGap(gapStart, gapEnd) {
            if (!selectedSt√∂rung) {
                alert('Bitte w√§hlen Sie eine St√∂rung aus!');
                return;
            }
            
            let st√∂rungText = selectedSt√∂rung;
            
            if (selectedSt√∂rung === 'Sonstiges') {
                const customText = document.getElementById('sonstigesText').value.trim();
                if (!customText) {
                    alert('Bitte beschreiben Sie die St√∂rung!');
                    return;
                }
                st√∂rungText = 'Sonstiges: ' + customText;
            }
            
            const duration = Math.round((gapEnd - gapStart) / 60000);
            const startDate = new Date(gapStart);
            const timestamp = startDate.toLocaleString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const st√∂rung = {
                id: Date.now(),
                timestamp: timestamp,
                startTime: new Date(gapStart),
                endTime: new Date(gapEnd),
                pr√ºfnummer: state.pr√ºfnummer,
                type: st√∂rungText,
                duration: duration,
                st√∂rungType: 'st√∂rung'
            };
            state.st√∂rungen.push(st√∂rung);
            console.log('St√∂rung f√ºr Gap gespeichert:', st√∂rung);
            
            // Clear unaddressed gap since it's now addressed
            state.unaddressedGapStart = null;
            
            closeModal();
            selectedSt√∂rung = null;
            updateTimeline();
            updateIdleWarning();
            showSuccess(`St√∂rung erfasst: ${st√∂rungText} (${duration} Min)`);
        }

        // Update timeline and idle warning periodically
        setInterval(() => {
            updateTimeline();
            updateIdleWarning();
        }, 1000);

        function openDatabase() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'databaseModal';
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            const pr√ºfungen = state.pr√ºfungen.sort((a, b) => b.id - a.id);

            let tableContent = '';
            if (pr√ºfungen.length === 0) {
                tableContent = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-text">Noch keine Eintr√§ge vorhanden</div>
                    </div>
                `;
            } else {
                const rows = pr√ºfungen.map(entry => {
                    const tbkNr = entry.teilekarte && entry.teilekarte.teilekartenNr ? entry.teilekarte.teilekartenNr : '-';
                    const pr√ºfzyklus = entry.pr√ºfzyklus || '-';
                    return `
                        <tr>
                            <td>${entry.startzeitFormatted || '-'}</td>
                            <td>${entry.endzeitFormatted || '-'}</td>
                            <td>${entry.pr√ºfnummer}</td>
                            <td>${pr√ºfzyklus}</td>
                            <td>${tbkNr}</td>
                            <td>${entry.part}</td>
                            <td><span class="data-badge io">${entry.io} i.O.</span></td>
                            <td><span class="data-badge nio">${entry.nio} n.i.O.</span></td>
                            <td>${entry.total}</td>
                        </tr>
                    `;
                }).join('');

                tableContent = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Start</th>
                                <th>Ende</th>
                                <th>Pr√ºfer</th>
                                <th>Zyklus</th>
                                <th>TBK-Nr.</th>
                                <th>Teil</th>
                                <th>i.O.</th>
                                <th>n.i.O.</th>
                                <th>Gesamt</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                `;
            }

            modal.innerHTML = `
                <div class="modal-content database-modal-content">
                    <div class="database-header">
                        <h2>üóÑÔ∏è Pr√ºfungen Datenbank</h2>
                        <button class="database-close-btn" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="database-body">
                        ${tableContent}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openSt√∂rungDatabase() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'databaseModal';
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            const st√∂rungen = state.st√∂rungen.sort((a, b) => b.id - a.id);

            let tableContent = '';
            if (st√∂rungen.length === 0) {
                tableContent = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Noch keine St√∂rungen vorhanden</div>
                    </div>
                `;
            } else {
                const rows = st√∂rungen.map(entry => {
                    const durationText = entry.duration !== null ? `${entry.duration} Min` : '-';
                    return `
                        <tr>
                            <td>${entry.timestamp}</td>
                            <td>${entry.pr√ºfnummer}</td>
                            <td>${entry.type}</td>
                            <td><span class="data-badge st√∂rung">${durationText}</span></td>
                        </tr>
                    `;
                }).join('');

                tableContent = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Zeitstempel</th>
                                <th>Pr√ºfer</th>
                                <th>St√∂rungsgrund</th>
                                <th>Dauer</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                `;
            }

            modal.innerHTML = `
                <div class="modal-content database-modal-content">
                    <div class="database-header">
                        <h2>‚ö†Ô∏è St√∂rungen Datenbank</h2>
                        <button class="database-close-btn" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="database-body">
                        ${tableContent}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.getElementById('pr√ºfungModal') || document.getElementById('st√∂rungModal') || document.getElementById('databaseModal') || document.getElementById('teilekartenModal');
            if (modal) modal.remove();
        }

        function showSuccess(msg) {
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; top: 30px; right: 30px; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4); font-weight: 600; z-index: 10000;`;
            toast.textContent = '‚úì ' + msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }



        function toggleStatus() {
            state.machineActive = !state.machineActive;
            const toggle = document.getElementById('statusToggle');
            const text = document.getElementById('statusText');
            
            if (state.machineActive) {
                toggle.classList.remove('inactive');
                toggle.classList.add('active');
                text.textContent = 'In Betrieb';
            } else {
                toggle.classList.remove('active');
                toggle.classList.add('inactive');
                text.textContent = 'Au√üer Betrieb';
            }
            updateContentGlow();
        }
    </script>

    <!-- App JavaScript Files (MUST load BEFORE Firebase!) -->
    <script src="./js/mde-main.js"></script>
    <script src="./js/auto-mode.js"></script>
    <script src="./js/manual-mode.js"></script>
    <script src="./js/pr√ºfung-summary.js"></script>
    <script src="./js/timeline.js"></script>

    <!-- Firebase SDK (v9 Compat Mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="./js/firebase-config.js"></script>

    <!-- Firebase PLC Simulator -->
    <script src="./js/firebase-plc.js"></script>

    <!-- Firebase Initialisierung -->
    <script>
        // Firebase initialisieren wenn Seite geladen ist
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof initFirebase === 'function') {
                const success = initFirebase();
                if (success) {
                    console.log('üöÄ Firebase PLC Simulator bereit');
                    console.log('');
                    console.log('üìã Verf√ºgbare Status-Codes:');
                    console.log('   -10 = St√∂rung (Malfunction)');
                    console.log('    10 = Betriebsbereit (Ready)');
                    console.log('    20 = Test starten (Productive)');
                    console.log('     0 = Heruntergefahren (Shutdown)');
                    console.log('');
                    console.log('üí° Tipp: √Ñndern Sie den Wert "plc/status" in der Firebase Realtime Database');
                    console.log('   um verschiedene Aktionen zu simulieren.');
                }
            }
        });
    </script>
</body>
</html>
